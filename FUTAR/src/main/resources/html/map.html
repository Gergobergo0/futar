<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>T√©rk√©p</title>
    <style>
        html, body, #map { height: 100%; margin: 0; }
    </style>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
</head>
<body>
<div id="map"></div>
<script>
    var defaultIcon = L.icon({
        iconUrl: 'https://img.icons8.com/?size=100&id=13800&format=png&color=000000',
        iconSize: [35, 41],
        iconAnchor: [12, 41],
        popupAnchor: [1, -34],
        shadowSize: [41, 41]
    });

    var highlightedIcon = L.icon({
        iconUrl: 'https://img.icons8.com/?size=100&id=13800&format=png&color=000000',
        iconSize: [42, 49],
        iconAnchor: [15, 48],
        popupAnchor: [1, -34],
        shadowSize: [41, 41]
    });

    var map = L.map('map').setView([47.4979, 19.0402], 13);

    var light = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
        attribution: '&copy; <a href="https://carto.com/">CartoDB</a>',
        subdomains: 'abcd',
        maxZoom: 19
    });

    var dark = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
        attribution: '&copy; <a href="https://carto.com/">CartoDB</a>',
        subdomains: 'abcd',
        maxZoom: 19
    });

    var allStops = [];
    var selectedMarker = null;

    function logToJava(message) {
        if (window.java && window.java.javaLog) {
            window.java.javaLog(message);
        } else {
            console.warn("Java objektum nem el√©rhet≈ë m√©g");
        }
    }
    function toggleFavorite() {
        if (window.java && typeof window.java.toggleFavorite === 'function') {
            logToJava("üìå Java toggleFavorite() megh√≠v√°sa");
            window.java.toggleFavorite();
        } else {
            logToJava("‚ùå java.toggleFavorite nem el√©rhet≈ë");
        }
    }


    function addStopTracked(lat, lng, name, stopId) {
        var marker = L.marker([lat, lng], { icon: defaultIcon });
        marker.bindPopup(name);

        marker.on('click', function () {
            console.log("Marker clicked: " + stopId + " (" + name + ")");

            if (selectedMarker && selectedMarker !== marker) {
                selectedMarker.setIcon(defaultIcon);
            }

            selectedMarker = marker;
            marker.setIcon(highlightedIcon);

            if (window.java && window.java.javaGetStopDetails) {
                window.java.javaGetStopDetails(stopId, name, lat, lng);
            }
        });

        marker.addTo(map);
        allStops.push(marker);
    }


    function updatePopupContent(stopName, htmlContent) {
        if (selectedMarker) {
            selectedMarker.setPopupContent("<b>" + stopName + "</b><br>" + htmlContent);
            selectedMarker.openPopup(); // üí• ez kell
        }
        }

    window.onRouteClick = function(tripId) {
        if (window.java && window.java.handleRouteClick) {
            window.java.handleRouteClick(tripId);
        } else {
            logToJava("handleRouteClick nem el√©rhet≈ë");
        }
    }
    function clearRouteLine() {
        if (routeLine) {
            map.removeLayer(routeLine);
            routeLine = null;
        }
        routeMarkers.forEach(marker => map.removeLayer(marker));
        routeMarkers = [];
    }



    function clearStops() {
        for (var i = 0; i < allStops.length; i++) {
            map.removeLayer(allStops[i]);
        }
        allStops = [];
        selectedMarker = null;
    }

    window.focusOn = function(lat, lng) {
        map.setView([lat, lng], 17);
    };


    light.addTo(map);

    var baseMaps = {
        "Vil√°gos": light,
        "S√∂t√©t": dark
    };
    function closePopup() {
        if (selectedMarker) {
            selectedMarker.closePopup();
        }
    }
    L.control.layers(baseMaps).addTo(map);
    var routeLine = null;
    var routeMarkers = [];

    function showRouteLine(lat1, lng1, lat2, lng2, distanceKmText) {
        // T√∂r√∂lj√ºk az el≈ëz≈ë vonalat √©s markereket
        if (routeLine) {
            map.removeLayer(routeLine);
            routeLine = null;
        }
        routeMarkers.forEach(marker => map.removeLayer(marker));
        routeMarkers = [];

        // Marker: honnan
        var marker1 = L.marker([lat1, lng1], { icon: highlightedIcon }).addTo(map);
        var marker2 = L.marker([lat2, lng2], { icon: highlightedIcon }).addTo(map);
        routeMarkers.push(marker1, marker2);

        // Vonal
        routeLine = L.polyline([[lat1, lng1], [lat2, lng2]], { color: 'blue' }).addTo(map);

        // Felirat k√∂z√©pre
        var midLat = (lat1 + lat2) / 2;
        var midLng = (lng1 + lng2) / 2;
        var label = L.marker([midLat, midLng], {
            icon: L.divIcon({
                className: 'distance-label',
                html: '<div style="background:white;padding:2px 6px;border-radius:4px;border:1px solid #ccc;">' + distanceKmText + '</div>',
                iconSize: [100, 24]
            })
        }).addTo(map);
        routeMarkers.push(label);

        // F√≥kusz
        var bounds = L.latLngBounds([[lat1, lng1], [lat2, lng2]]);
        map.fitBounds(bounds, { padding: [50, 50] });
    }

    map.on('popupclose', function () {
        if (window.java && window.java.onPopupClosed) {
            window.java.onPopupClosed();
        }
    });

</script>
</body>
</html>
