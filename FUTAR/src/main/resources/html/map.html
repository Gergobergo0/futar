<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Térkép</title>
    <style>
        html, body, #map { height: 100%; margin: 0; }
    </style>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
</head>
<body>
<div id="map"></div>
<script>
    // Alap ikon (minden marker ezt használja kezdetben)
    var defaultIcon = L.icon({
        iconUrl: 'https://unpkg.com/leaflet@1.7.1/dist/images/marker-icon.png',
        iconSize: [25, 41],
        iconAnchor: [12, 41],
        popupAnchor: [1, -34],
        shadowUrl: 'https://unpkg.com/leaflet@1.7.1/dist/images/marker-shadow.png',
        shadowSize: [41, 41]
    });
    var activeMarker = null;

    // Kiemelt ikon (nagyobb és piros színű)
    var highlightedIcon = L.icon({
        iconUrl: 'https://unpkg.com/leaflet@1.7.1/dist/images/marker-icon-red.png', // piros ikon
        iconSize: [30, 48],
        iconAnchor: [15, 48],
        popupAnchor: [1, -34],
        shadowUrl: 'https://unpkg.com/leaflet@1.7.1/dist/images/marker-shadow.png',
        shadowSize: [41, 41]
    });

    function logToJava(message) {
        if (window.java && window.java.javaLog) {
            window.java.javaLog(message); // Java log meghívása
        } else {
            console.warn("Java objektum nem elérhető még");
        }
    }


    // Térkép inicializálása
    var map = L.map('map').setView([47.4979, 19.0402], 13);

    // Light és dark tile layerek
    var light = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
        attribution: '&copy; <a href="https://carto.com/">CartoDB</a>',
        subdomains: 'abcd',
        maxZoom: 19
    });

    var dark = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
        attribution: '&copy; <a href="https://carto.com/">CartoDB</a>',
        subdomains: 'abcd',
        maxZoom: 19
    });

    // Marker hozzáadása és kattintás esemény kezelése
    function addStopTracked(lat, lng, name) {
        var marker = L.marker([lat, lng], { icon: defaultIcon });

        marker.bindPopup(name);
        marker.on('click', function () {
            if (window.java && window.java.javaGetStopDetails) {
                window.java.javaGetStopDetails(name, lat, lng);
            }

            // Kiemelés kezelése
            if (activeMarker) {
                activeMarker.setIcon(defaultIcon); // előző marker visszaállítása
            }
            marker.setIcon(highlightedIcon); // aktuális kiemelése
            activeMarker = marker;
        });

        marker.addTo(map);
        allStops.push(marker);
    }


    function updatePopupContent(stopName, htmlContent) {
        map.eachLayer(function (layer) {
            if (layer instanceof L.Marker && layer.getPopup().getContent().startsWith(stopName)) {
                layer.closePopup(); // <-- először biztosan bezárjuk
                layer.setPopupContent(stopName + "<br>" + htmlContent);
                setTimeout(() => {
                    layer.openPopup(); // <-- majd újra nyitjuk egy minimális delay-jel
                }, 100);
            }
        });
    }

    var allStops = [];

    function clearStops() {
        for (var i = 0; i < allStops.length; i++) {
            map.removeLayer(allStops[i]);
        }
        allStops = [];
        activeMarker = null; // reseteljük az aktuális markert is
    }


    // Alapértelmezetten világos
    light.addTo(map);

    // Váltógomb a sarokban
    var baseMaps = {
        "Világos": light,
        "Sötét": dark
    };

    L.control.layers(baseMaps).addTo(map);
</script>




</body>
</html>
